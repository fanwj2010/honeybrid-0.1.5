<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>honeybrid: pcap_tool.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>pcap_tool.c File Reference</h1>Pcap function to record communications.  
<a href="#_details">More...</a>
<p>
<code>#include &lt;sys/time.h&gt;</code><br>
<code>#include &lt;glib.h&gt;</code><br>
<code>#include &quot;<a class="el" href="pcap__tool_8h-source.html">pcap_tool.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="tables_8h-source.html">tables.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="log_8h-source.html">log.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Include dependency graph for pcap_tool.c:</div>
<div class="dynsection">
<p><center><img src="pcap__tool_8c__incl.png" border="0" usemap="#pcap_tool.c_map" alt=""></center>
<map name="pcap_tool.c_map">
<area shape="rect" href="pcap__tool_8h.html" title="pcap_tool.h" alt="" coords="228,84,324,111"><area shape="rect" href="tables_8h.html" title="tables.h" alt="" coords="709,84,781,111"><area shape="rect" href="log_8h.html" title="log.h" alt="" coords="631,316,681,343"><area shape="rect" href="types_8h.html" title="types.h" alt="" coords="712,161,779,188"><area shape="rect" href="modules_8h.html" title="modules.h" alt="" coords="772,239,860,265"></map>
</div>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">GString *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pcap__tool_8c.html#3e046706f93936499d648d390788c324">create_pcap_filename</a> (int mode)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">create a filename based on the configuration and a time value  <a href="#3e046706f93936499d648d390788c324"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pcap__tool_8c.html#c166bb250c9a3accffbe546af29ea7f2">init_pcap_context</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">create the pcap descriptors  <a href="#c166bb250c9a3accffbe546af29ea7f2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pcap__tool_8c.html#5d1b6b8c7266a5d1b7ac6e805fa977b8">record_pkt</a> (struct nfq_data *tb, char *p, int mode)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">record a <a class="el" href="structpacket.html">packet</a> in the current pcap file descriptor  <a href="#5d1b6b8c7266a5d1b7ac6e805fa977b8"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pcap__tool_8c.html#8809f8a26967cdc4c996d596fc2262b4">close_pcap_context</a> ()</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Pcap function to record communications. 
<p>
J. Vehent <hr><h2>Function Documentation</h2>
<a class="anchor" name="8809f8a26967cdc4c996d596fc2262b4"></a><!-- doxytag: member="pcap_tool.c::close_pcap_context" ref="8809f8a26967cdc4c996d596fc2262b4" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int close_pcap_context           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
close_pcap_context, close the descriptors <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>\return</em>&nbsp;</td><td>0 on success, anything else otherwise </td></tr>
  </table>
</dl>

<p>References <a class="el" href="pcap__tool_8h-source.html#l00048">pcap_main_desc</a>, <a class="el" href="pcap__tool_8h-source.html#l00056">pcap_output_current</a>, and <a class="el" href="pcap__tool_8h-source.html#l00063">pcap_output_redirected</a>.</p>

</div>
</div><p>
<a class="anchor" name="3e046706f93936499d648d390788c324"></a><!-- doxytag: member="pcap_tool.c::create_pcap_filename" ref="3e046706f93936499d648d390788c324" args="(int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GString* create_pcap_filename           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
create a filename based on the configuration and a time value 
<p>
create_pcap_filename<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>mode,0</em>&nbsp;</td><td>for non redirected file name, 1 for redirected file name </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>a GString structure </dd></dl>

<p>
prefix = value from the config file<p>
add the current time<p>
and finally, the '.pcap' extension<p>
return the structure GString created
<p>References <a class="el" href="tables_8h-source.html#l00053">config</a>.</p>

<p>Referenced by <a class="el" href="pcap__tool_8c-source.html#l00080">init_pcap_context()</a>, and <a class="el" href="pcap__tool_8c-source.html#l00143">record_pkt()</a>.</p>

</div>
</div><p>
<a class="anchor" name="c166bb250c9a3accffbe546af29ea7f2"></a><!-- doxytag: member="pcap_tool.c::init_pcap_context" ref="c166bb250c9a3accffbe546af29ea7f2" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int init_pcap_context           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
create the pcap descriptors 
<p>
init_pcap_context<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>0 on success, anything else otherwise </dd></dl>

<p>
pcap_open_dead, open offline context for pcap <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>DLT_RAW,assume</em>&nbsp;</td><td>incoming <a class="el" href="structpacket.html">packet</a> doesn't have a layer 2 header (netfilter requierement) </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>BUFSIZE,max</em>&nbsp;</td><td>size of a <a class="el" href="structpacket.html">packet</a> </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>pcap_main_desc, a descriptor to the pcap context</dd></dl>
L(32,"INIT_PCAP_CONTEXT",NULL,5);<p>
create output filename based on the conf and the time value<p>
pcap_dump_open, create an output file descriptor for this context <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>pcap_main_desc,a</em>&nbsp;</td><td>descriptor to the pcap context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>output_file_name-&gt;str,the</em>&nbsp;</td><td>filename </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>pcap_output_current, a pcap file descriptor</dd></dl>
L(33,"INIT_PCAP_CONTEXT",NULL, 5);<p>
L(34,"INIT_PCAP_CONTEXT",output_file_name-&gt;str, 5);<p>
create output filename for redirected connections<p>
same for output of redirected connections<p>
L(35,"INIT_PCAP_CONTEXT",NULL, 5);<p>
L(34,"INIT_PCAP_CONTEXT",redirected_output_file_name-&gt;str, 5); 
<p>References <a class="el" href="pcap__tool_8c-source.html#l00041">create_pcap_filename()</a>, <a class="el" href="pcap__tool_8h-source.html#l00048">pcap_main_desc</a>, <a class="el" href="pcap__tool_8h-source.html#l00056">pcap_output_current</a>, <a class="el" href="pcap__tool_8h-source.html#l00063">pcap_output_redirected</a>, and <a class="el" href="pcap__tool_8h-source.html#l00041">PCAPSIZE</a>.</p>

<p>Referenced by <a class="el" href="pcap__tool_8c-source.html#l00143">record_pkt()</a>.</p>

</div>
</div><p>
<a class="anchor" name="5d1b6b8c7266a5d1b7ac6e805fa977b8"></a><!-- doxytag: member="pcap_tool.c::record_pkt" ref="5d1b6b8c7266a5d1b7ac6e805fa977b8" args="(struct nfq_data *tb, char *p, int mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int record_pkt           </td>
          <td>(</td>
          <td class="paramtype">struct nfq_data *&nbsp;</td>
          <td class="paramname"> <em>tb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
record a <a class="el" href="structpacket.html">packet</a> in the current pcap file descriptor 
<p>
record_pkt<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>nfq_data</em>&nbsp;</td><td>*tb, raw <a class="el" href="structpacket.html">packet</a> ( used with nfqueue) </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>*payload,<a class="el" href="structpacket.html">packet</a></em>&nbsp;</td><td>to record (used outside of nfqueue) </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>mode,0</em>&nbsp;</td><td>for non redirected connection, 1 for redirected connections, 2 for redirected outside nfqueue, 3 for non redirected outside nfqueue</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>0 on success, anything else otherwise </dd></dl>

<p>
if pcap desc doesn't exist, init pcap context<p>
switch the descriptor regarding to the mode (redirected or not)<p>
if the actual pcap output file is bigger than 10mo, create a new one<p>
close the current descriptor<p>
create output filename based on the conf and the time value<p>
open the new file descriptor<p>
L(33,"RECORD_PKT",file_name-&gt;str, 5);<p>
L(34,"RECORD_PKT",file_name-&gt;str,5);<p>
store new descriptor in global descriptor<p>
create pcap specific header<p>
mode 2 and 3 are used when we need to record a <a class="el" href="structpacket.html">packet</a> received outside of the netfilter queue<p>
+1 because the '' is not included<p>
pcap_dump, write pcap header and <a class="el" href="structpacket.html">packet</a> data to the output file <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>pcap_output_current,descriptor</em>&nbsp;</td><td>to the current output file </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>&amp;phdr,pcap</em>&nbsp;</td><td>header </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>payload,<a class="el" href="structpacket.html">packet</a></em>&nbsp;</td><td>data</td></tr>
  </table>
</dl>
pcap_dump, write pcap header and <a class="el" href="structpacket.html">packet</a> data to the output file <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>pcap_output_current,descriptor</em>&nbsp;</td><td>to the current output file </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>&amp;phdr,pcap</em>&nbsp;</td><td>header </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>(const</em>&nbsp;</td><td>u_char *)nf_packet, <a class="el" href="structpacket.html">packet</a> data from netfilter queue</td></tr>
  </table>
</dl>
L(36,"RECORD_PKT",NULL, 5); 
<p>References <a class="el" href="pcap__tool_8c-source.html#l00041">create_pcap_filename()</a>, <a class="el" href="pcap__tool_8c-source.html#l00080">init_pcap_context()</a>, <a class="el" href="pcap__tool_8h-source.html#l00048">pcap_main_desc</a>, <a class="el" href="pcap__tool_8h-source.html#l00056">pcap_output_current</a>, and <a class="el" href="pcap__tool_8h-source.html#l00063">pcap_output_redirected</a>.</p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Feb 9 10:46:08 2010 for honeybrid by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
