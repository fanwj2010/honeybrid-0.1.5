<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>honeybrid: decision_engine.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>decision_engine.c File Reference</h1>Decision Engine for honeybrid.  
<a href="#_details">More...</a>
<p>
<code>#include &lt;malloc.h&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include &lt;glib.h&gt;</code><br>
<code>#include &quot;<a class="el" href="decision__engine_8h-source.html">decision_engine.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="netcode_8h-source.html">netcode.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="modules_8h-source.html">modules.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="tables_8h-source.html">tables.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="log_8h-source.html">log.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Include dependency graph for decision_engine.c:</div>
<div class="dynsection">
<p><center><img src="decision__engine_8c__incl.png" border="0" usemap="#decision_engine.c_map" alt=""></center>
<map name="decision_engine.c_map">
<area shape="rect" href="decision__engine_8h.html" title="decision_engine.h" alt="" coords="248,84,384,111"><area shape="rect" href="tables_8h.html" title="tables.h" alt="" coords="451,161,523,188"><area shape="rect" href="modules_8h.html" title="modules.h" alt="" coords="463,316,551,343"><area shape="rect" href="log_8h.html" title="log.h" alt="" coords="616,393,667,420"><area shape="rect" href="netcode_8h.html" title="netcode.h" alt="" coords="779,84,864,111"><area shape="rect" href="types_8h.html" title="types.h" alt="" coords="748,239,815,265"></map>
</div>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct <a class="el" href="structnode.html">node</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="decision__engine_8c.html#d52851b04cf58a598a0488e52705cb41">DE_build_subtree</a> (const gchar *expr)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">recursively process the expression and creates the nodes  <a href="#d52851b04cf58a598a0488e52705cb41"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="decision__engine_8c.html#4235b084499261f6e0e6faf8bc529951">DE_create_tree</a> (const gchar *equation)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">build a boolean decision <a class="el" href="structtree.html">tree</a> for a given equation  <a href="#4235b084499261f6e0e6faf8bc529951"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="decision__engine_8c.html#cffa39c5d5f7614fc22b0792f6235a4e">decide</a> (struct <a class="el" href="structpkt__struct.html">pkt_struct</a> *pkt)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">decide upon a given paken if the connection is to be redirected or not  <a href="#cffa39c5d5f7614fc22b0792f6235a4e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="decision__engine_8c.html#5c13a1120e04937d7e462e468a1ef508">DE_process_packet</a> (struct <a class="el" href="structpkt__struct.html">pkt_struct</a> *pkt)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">submit packets for decision using decision rules and decision modules  <a href="#5c13a1120e04937d7e462e468a1ef508"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="decision__engine_8c.html#ed34912c70e4db4b07f42ff72495c5df">DE_submit_packet</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">handle connections being decided and submits packets for decision  <a href="#ed34912c70e4db4b07f42ff72495c5df"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="decision__engine_8c.html#f8865693460ce6b4b4d8e9334597c266">DE_push_pkt</a> (struct <a class="el" href="structpkt__struct.html">pkt_struct</a> *pkt)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">push <a class="el" href="structpacket.html">packet</a> to the DE_submit_pkt queue (equivalent of <a class="el" href="decision__engine_8c.html#ed34912c70e4db4b07f42ff72495c5df" title="handle connections being decided and submits packets for decision">DE_submit_packet()</a> but without using a thread)  <a href="#f8865693460ce6b4b4d8e9334597c266"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Decision Engine for honeybrid. 
<p>
This engine creates boolean decision trees from a rule list and process incoming connection using those trees. If the <a class="el" href="structtree.html">tree</a> return TRUE, the redirected value of the connection is set to 1.<p>
<dl class="author" compact><dt><b>Author:</b></dt><dd>Julien Vehent, 2007 <p>
Thomas Coquelin, 2008 </dd></dl>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="d52851b04cf58a598a0488e52705cb41"></a><!-- doxytag: member="decision_engine.c::DE_build_subtree" ref="d52851b04cf58a598a0488e52705cb41" args="(const gchar *expr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structnode.html">node</a>* DE_build_subtree           </td>
          <td>(</td>
          <td class="paramtype">const gchar *&nbsp;</td>
          <td class="paramname"> <em>expr</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
recursively process the expression and creates the nodes 
<p>
build_subtree <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>expr,a</em>&nbsp;</td><td>part of the boolean equation </td></tr>
  </table>
</dl>

<p>
TODO: to be freed when destroying DE_rules<p>
test presence of AND operator<p>
composed expression: separate the left part<p>
split on "AND" operator<p>
process left part of the AND<p>
call function with right side of expr<p>
single module in expression, just add the leaf<p>
get module structure from DE_mod<p>
return pointer to this leaf 
<p>References <a class="el" href="modules_8h-source.html#l00053">node::arg</a>, <a class="el" href="err_8c-source.html#l00076">errx()</a>, <a class="el" href="modules_8h-source.html#l00057">node::false</a>, <a class="el" href="modules_8h-source.html#l00055">node::function</a>, <a class="el" href="tables_8h-source.html#l00058">module</a>, <a class="el" href="structnode.html#fdccefeda4700574838354548b2c0e96">node::module</a>, <a class="el" href="modules_8h-source.html#l00054">node::module_name</a>, and <a class="el" href="modules_8h-source.html#l00056">node::true</a>.</p>

<p>Referenced by <a class="el" href="decision__engine_8c-source.html#l00128">DE_create_tree()</a>.</p>

</div>
</div><p>
<a class="anchor" name="4235b084499261f6e0e6faf8bc529951"></a><!-- doxytag: member="decision_engine.c::DE_create_tree" ref="4235b084499261f6e0e6faf8bc529951" args="(const gchar *equation)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* DE_create_tree           </td>
          <td>(</td>
          <td class="paramtype">const gchar *&nbsp;</td>
          <td class="paramname"> <em>equation</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
build a boolean decision <a class="el" href="structtree.html">tree</a> for a given equation 
<p>
DE_create_tree <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>equation</em>&nbsp;</td><td>a boolean equation</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>tree_root a pointer to the root of the boolean decision <a class="el" href="structtree.html">tree</a> </dd></dl>

<p>
create a glib table to store the equation<p>
first subgroup<p>
store address of the root<p>
for all the other subgroups<p>
get the pointer to the beginning of the new subtree<p>
connect new subtree to the previous one subtree (n) is a son of subtree(n-1)<p>
and go to the next one<p>
in subtree (n-1), each FALSE branch is connected to the head of subtree(n)<p>
this subtree is done, so n become n-1 
<p>References <a class="el" href="decision__engine_8c-source.html#l00047">DE_build_subtree()</a>, <a class="el" href="modules_8h-source.html#l00057">node::false</a>, and <a class="el" href="modules_8h-source.html#l00056">node::true</a>.</p>

<p>Referenced by <a class="el" href="rules_8c-source.html#l01176">yyparse()</a>.</p>

</div>
</div><p>
<a class="anchor" name="5c13a1120e04937d7e462e468a1ef508"></a><!-- doxytag: member="decision_engine.c::DE_process_packet" ref="5c13a1120e04937d7e462e468a1ef508" args="(struct pkt_struct *pkt)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int DE_process_packet           </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpkt__struct.html">pkt_struct</a> *&nbsp;</td>
          <td class="paramname"> <em>pkt</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
submit packets for decision using decision rules and decision modules 
<p>
DE_process_packet 
<p>
default is to return "drop" to the QUEUE<p>
we update the state<p>
we release the <a class="el" href="structpacket.html">packet</a><p>
no backend defined, so we simply forward the packets to its destination<p>
backend defined, so we'll use the backend_rule for the next <a class="el" href="structpacket.html">packet</a><p>
we leave the state unmodified (the rule probably needs more material to decide), and we release the <a class="el" href="structpacket.html">packet</a> 
<p>References <a class="el" href="types_8h-source.html#l00045">target::back_rule</a>, <a class="el" href="types_8h-source.html#l00212">pkt_struct::conn</a>, <a class="el" href="tables_8h-source.html#l00133">CONTROL</a>, <a class="el" href="types_8h-source.html#l00046">target::control_rule</a>, <a class="el" href="decision__engine_8h-source.html#l00033">DE_ACCEPT</a>, <a class="el" href="decision__engine_8h-source.html#l00030">DE_NO_RULE</a>, <a class="el" href="decision__engine_8h-source.html#l00032">DE_REJECT</a>, <a class="el" href="decision__engine_8h-source.html#l00031">DE_UNKNOWN</a>, <a class="el" href="decision__engine_8c-source.html#l00196">decide()</a>, <a class="el" href="tables_8h-source.html#l00128">DECISION</a>, <a class="el" href="types_8h-source.html#l00190">conn_struct::decision_packet_id</a>, <a class="el" href="tables_8h-source.html#l00132">DROP</a>, <a class="el" href="types_8h-source.html#l00043">target::front_rule</a>, <a class="el" href="log_8h-source.html#l00100">H</a>, <a class="el" href="types_8h-source.html#l00173">conn_struct::id</a>, <a class="el" href="tables_8h-source.html#l00127">INIT</a>, <a class="el" href="types_8h-source.html#l00164">conn_struct::key</a>, <a class="el" href="tables_8h-source.html#l00140">OK</a>, <a class="el" href="tables_8h-source.html#l00131">PROXY</a>, <a class="el" href="tables_8c-source.html#l00934">setup_redirection()</a>, <a class="el" href="types_8h-source.html#l00172">conn_struct::state</a>, <a class="el" href="tables_8c-source.html#l00223">switch_state()</a>, <a class="el" href="types_8h-source.html#l00182">conn_struct::target</a>, and <a class="el" href="types_8h-source.html#l00188">conn_struct::total_packet</a>.</p>

<p>Referenced by <a class="el" href="decision__engine_8c-source.html#l00423">DE_submit_packet()</a>.</p>

</div>
</div><p>
<a class="anchor" name="f8865693460ce6b4b4d8e9334597c266"></a><!-- doxytag: member="decision_engine.c::DE_push_pkt" ref="f8865693460ce6b4b4d8e9334597c266" args="(struct pkt_struct *pkt)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void DE_push_pkt           </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpkt__struct.html">pkt_struct</a> *&nbsp;</td>
          <td class="paramname"> <em>pkt</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
push <a class="el" href="structpacket.html">packet</a> to the DE_submit_pkt queue (equivalent of <a class="el" href="decision__engine_8c.html#ed34912c70e4db4b07f42ff72495c5df" title="handle connections being decided and submits packets for decision">DE_submit_packet()</a> but without using a thread) 
<p>
DE_push_pkt DEPRECATED, <dl compact><dt><b><a class="el" href="todo.html#_todo000002">Todo:</a></b></dt><dd>to remove </dd></dl>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>pkt,:</em>&nbsp;</td><td><a class="el" href="structpacket.html">packet</a> to push </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>OK </dd></dl>

<p>References <a class="el" href="types_8h-source.html#l00212">pkt_struct::conn</a>, <a class="el" href="decision__engine_8h-source.html#l00061">DE_queue</a>, <a class="el" href="decision__engine_8h-source.html#l00059">DE_queue_lock</a>, <a class="el" href="log_8h-source.html#l00100">H</a>, and <a class="el" href="types_8h-source.html#l00173">conn_struct::id</a>.</p>

</div>
</div><p>
<a class="anchor" name="ed34912c70e4db4b07f42ff72495c5df"></a><!-- doxytag: member="decision_engine.c::DE_submit_packet" ref="ed34912c70e4db4b07f42ff72495c5df" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void DE_submit_packet           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
handle connections being decided and submits packets for decision 
<p>
DE_submit_packet DEPRECATED, <dl compact><dt><b><a class="el" href="todo.html#_todo000001">Todo:</a></b></dt><dd>to remove </dd></dl>

<p>
Now that this entry was processed, we can remove it from the DE queue 
<p>References <a class="el" href="decision__engine_8c-source.html#l00275">DE_process_packet()</a>, <a class="el" href="decision__engine_8h-source.html#l00061">DE_queue</a>, <a class="el" href="decision__engine_8h-source.html#l00059">DE_queue_lock</a>, <a class="el" href="tables_8h-source.html#l00140">OK</a>, and <a class="el" href="tables_8h-source.html#l00039">threading</a>.</p>

<p>Referenced by <a class="el" href="honeybrid_8c-source.html#l01009">main()</a>.</p>

</div>
</div><p>
<a class="anchor" name="cffa39c5d5f7614fc22b0792f6235a4e"></a><!-- doxytag: member="decision_engine.c::decide" ref="cffa39c5d5f7614fc22b0792f6235a4e" args="(struct pkt_struct *pkt)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int decide           </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpkt__struct.html">pkt_struct</a> *&nbsp;</td>
          <td class="paramname"> <em>pkt</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
decide upon a given paken if the connection is to be redirected or not 
<p>
decide <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>pkt,:</em>&nbsp;</td><td><a class="el" href="structpacket.html">packet</a> used to decide </td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>decision </dd></dl>

<p>
globalresult is used to store the final result of the boolean equation of module 3 possible outcome: "-1" means "can't decide, needs more data to decide" "0" means "reject" "1" means "accept"<p>
start processing the <a class="el" href="structtree.html">tree</a> from the root<p>
node-&gt;result is used to store the outcome of an individual module<p>
node-&gt;info_result is used to store additional information about the decision<p>
call module<p>
if result is true, forward to true <a class="el" href="structnode.html">node</a> or exit with 1<p>
update decision_rule information<p>
go to next <a class="el" href="structnode.html">node</a><p>
end of the <a class="el" href="structtree.html">tree</a>, exit<p>
end of the <a class="el" href="structtree.html">tree</a>, exit<p>
result is false (result == 0), forward to false <a class="el" href="structnode.html">node</a> or exit with 0<p>
go to the next subgroup<p>
end of the <a class="el" href="structtree.html">tree</a>, exit 
<p>References <a class="el" href="types_8h-source.html#l00212">pkt_struct::conn</a>, <a class="el" href="types_8h-source.html#l00192">conn_struct::decision_rule</a>, <a class="el" href="log_8h-source.html#l00100">H</a>, <a class="el" href="types_8h-source.html#l00173">conn_struct::id</a>, <a class="el" href="modules_8h-source.html#l00040">mod_args::node</a>, <a class="el" href="modules_8h-source.html#l00041">mod_args::pkt</a>, and <a class="el" href="modules_8c-source.html#l00069">run_module()</a>.</p>

<p>Referenced by <a class="el" href="decision__engine_8c-source.html#l00275">DE_process_packet()</a>.</p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Feb 9 10:46:07 2010 for honeybrid by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
